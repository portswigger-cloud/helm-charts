suite: Controller env Secret configuration
templates:
  - controller-env-secret.yaml
tests:
  - it: should create Secret with default values
    template: controller-env-secret.yaml
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: RELEASE-NAME-scan-controller-env
      - equal:
          path: metadata.namespace
          value: NAMESPACE
      - equal:
          path: type
          value: Opaque
      - equal:
          path: data.BSEE_SERVER_URL
          decodeBase64: true
          value: https://not-a-server.url
      - equal:
          path: data.BSEE_HOSTED_SCANNING_MACHINE_API_KEY
          decodeBase64: true
          value: not-an-api-key
      - equal:
          path: data.BSEE_HOSTED_SCAN_JOB_TEMPLATE
          decodeBase64: true
          value: YXBpVmVyc2lvbjogYmF0Y2gvdjEKa2luZDogSm9iCm1ldGFkYXRhOgogIG5hbWU6IHNjYW4KICBsYWJlbHM6CiAgICAgICAgaGVsbS5zaC9jaGFydDogc2Nhbi1jb250cm9sbGVyLTAuMC4xCiAgICAgICAgYXBwLmt1YmVybmV0ZXMuaW8vbmFtZTogc2Nhbi1jb250cm9sbGVyCiAgICAgICAgYXBwLmt1YmVybmV0ZXMuaW8vaW5zdGFuY2U6IFJFTEVBU0UtTkFNRQogICAgICAgIGFwcC5rdWJlcm5ldGVzLmlvL3ZlcnNpb246ICIyMDIzLjktMTQwMTkiCiAgICAgICAgYXBwLmt1YmVybmV0ZXMuaW8vbWFuYWdlZC1ieTogSGVsbQpzcGVjOgogIGJhY2tvZmZMaW1pdDogMAogIHR0bFNlY29uZHNBZnRlckZpbmlzaGVkOiAzNjAwCiAgdGVtcGxhdGU6CiAgICBtZXRhZGF0YToKICAgICAgbGFiZWxzOgogICAgICAgIGFwcC5rdWJlcm5ldGVzLmlvL2NvbXBvbmVudDogc2Nhbi1jb250cm9sbGVyLXNjYW5uZXIKICAgICAgICBhcHAua3ViZXJuZXRlcy5pby9pbnN0YW5jZTogUkVMRUFTRS1OQU1FCiAgICAgIGFubm90YXRpb25zOgogICAgICAgIGNsdXN0ZXItYXV0b3NjYWxlci5rdWJlcm5ldGVzLmlvL3NhZmUtdG8tZXZpY3Q6ICJmYWxzZSIKICAgICAgICBrYXJwZW50ZXIuc2gvZG8tbm90LWV2aWN0OiAidHJ1ZSIKICAgICAgICBrYXJwZW50ZXIuc2gvZG8tbm90LWRpc3J1cHQ6ICJ0cnVlIgogICAgc3BlYzoKICAgICAgc2VydmljZUFjY291bnQ6IHNjYW5uZXIKICAgICAgc2VydmljZUFjY291bnROYW1lOiBzY2FubmVyCiAgICAgIGF1dG9tb3VudFNlcnZpY2VBY2NvdW50VG9rZW46IGZhbHNlCiAgICAgIGNvbnRhaW5lcnM6CiAgICAgICAgLSBuYW1lOiBzY2FuLWNvbnRhaW5lcgogICAgICAgICAgZW52OgogICAgICAgICAgICAtIG5hbWU6IEpBVkFfT1BUUwogICAgICAgICAgICAgIHZhbHVlOiAtWG1zNTEybSAtWG14NTEybQogICAgICAgICAgICAtIG5hbWU6IEJVUlBfSkFWQV9PUFRTCiAgICAgICAgICAgICAgdmFsdWU6IC1YWDpJbml0aWFsUkFNUGVyY2VudGFnZT03NSAtWFg6TWF4UkFNUGVyY2VudGFnZT03NQogICAgICAgICAgZW52RnJvbToKICAgICAgICAgICAgLSBzZWNyZXRSZWY6CiAgICAgICAgICAgICAgICBuYW1lOiBSRUxFQVNFLU5BTUUtc2Nhbi1jb250cm9sbGVyLXNjYW5uZXItZW52CiAgICAgICAgICBpbWFnZTogcHVibGljLmVjci5hd3MvcG9ydHN3aWdnZXIvcG9ydHN3aWdnZXItaG9zdGVkLXNjYW46MjAyMy45LTE0MDE5CiAgICAgICAgICBpbWFnZVB1bGxQb2xpY3k6IEFsd2F5cwogICAgICAgICAgcmVzb3VyY2VzOgogICAgICAgICAgICBsaW1pdHM6CiAgICAgICAgICAgICAgbWVtb3J5OiAxNEdpCiAgICAgICAgICAgIHJlcXVlc3RzOgogICAgICAgICAgICAgIGNwdTogMgogICAgICAgICAgICAgIG1lbW9yeTogMTRHaQogICAgICAgICAgc2VjdXJpdHlDb250ZXh0OgogICAgICAgICAgICBydW5Bc1VzZXI6IDEwMDAwMAogICAgICAgICAgICByZWFkT25seVJvb3RGaWxlc3lzdGVtOiB0cnVlCiAgICAgICAgICAgIGFsbG93UHJpdmlsZWdlRXNjYWxhdGlvbjogZmFsc2UKICAgICAgICAgICAgcHJpdmlsZWdlZDogZmFsc2UKICAgICAgICAgICAgY2FwYWJpbGl0aWVzOgogICAgICAgICAgICAgIGRyb3A6CiAgICAgICAgICAgICAgICAtIEFMTAogICAgICAgICAgdm9sdW1lTW91bnRzOgogICAgICAgICAgICAtIG1vdW50UGF0aDogL2hvbWUvYnVycHN1aXRlLwogICAgICAgICAgICAgIG5hbWU6IGhvbWUtYnVycHN1aXRlCiAgICAgICAgICAgIC0gbW91bnRQYXRoOiAvdG1wCiAgICAgICAgICAgICAgbmFtZTogdG1wCiAgICAgIHZvbHVtZXM6CiAgICAgICAgLSBuYW1lOiBob21lLWJ1cnBzdWl0ZQogICAgICAgICAgZW1wdHlEaXI6CiAgICAgICAgICAgIHNpemVMaW1pdDogMTBHaQogICAgICAgIC0gbmFtZTogdG1wCiAgICAgICAgICBlbXB0eURpcjoKICAgICAgICAgICAgc2l6ZUxpbWl0OiA1MTJNaQogICAgICByZXN0YXJ0UG9saWN5OiBOZXZlcgogICAgICB0ZXJtaW5hdGlvbkdyYWNlUGVyaW9kU2Vjb25kczogMzAKICAgICAgbm9kZVNlbGVjdG9yOgogICAgICAgIGt1YmVybmV0ZXMuaW8vYXJjaDogYW1kNjQK
      - equal:
          path: data.BSEE_MAX_SCAN_CONCURRENCY
          decodeBase64: true
          value: '"20"'
  - it: should create Secret with configured values
    template: controller-env-secret.yaml
    set:
      configuration:
        apiKey: "not-another-api-key"
        maxConcurrency: 50
      scanner:
        resources:
          limits:
            memory: 2Gi
          requests:
            cpu: 512Mi
            memory: 2Gi
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: RELEASE-NAME-scan-controller-env
      - equal:
          path: metadata.namespace
          value: NAMESPACE
      - equal:
          path: type
          value: Opaque
      - equal:
          path: data.BSEE_SERVER_URL
          decodeBase64: true
          value: https://not-a-server.url
      - equal:
          path: data.BSEE_HOSTED_SCANNING_MACHINE_API_KEY
          decodeBase64: true
          value: not-another-api-key
      - equal:
          path: data.BSEE_HOSTED_SCAN_JOB_TEMPLATE
          decodeBase64: true
          value: YXBpVmVyc2lvbjogYmF0Y2gvdjEKa2luZDogSm9iCm1ldGFkYXRhOgogIG5hbWU6IHNjYW4KICBsYWJlbHM6CiAgICAgICAgaGVsbS5zaC9jaGFydDogc2Nhbi1jb250cm9sbGVyLTAuMC4xCiAgICAgICAgYXBwLmt1YmVybmV0ZXMuaW8vbmFtZTogc2Nhbi1jb250cm9sbGVyCiAgICAgICAgYXBwLmt1YmVybmV0ZXMuaW8vaW5zdGFuY2U6IFJFTEVBU0UtTkFNRQogICAgICAgIGFwcC5rdWJlcm5ldGVzLmlvL3ZlcnNpb246ICIyMDIzLjktMTQwMTkiCiAgICAgICAgYXBwLmt1YmVybmV0ZXMuaW8vbWFuYWdlZC1ieTogSGVsbQpzcGVjOgogIGJhY2tvZmZMaW1pdDogMAogIHR0bFNlY29uZHNBZnRlckZpbmlzaGVkOiAzNjAwCiAgdGVtcGxhdGU6CiAgICBtZXRhZGF0YToKICAgICAgbGFiZWxzOgogICAgICAgIGFwcC5rdWJlcm5ldGVzLmlvL2NvbXBvbmVudDogc2Nhbi1jb250cm9sbGVyLXNjYW5uZXIKICAgICAgICBhcHAua3ViZXJuZXRlcy5pby9pbnN0YW5jZTogUkVMRUFTRS1OQU1FCiAgICAgIGFubm90YXRpb25zOgogICAgICAgIGNsdXN0ZXItYXV0b3NjYWxlci5rdWJlcm5ldGVzLmlvL3NhZmUtdG8tZXZpY3Q6ICJmYWxzZSIKICAgICAgICBrYXJwZW50ZXIuc2gvZG8tbm90LWV2aWN0OiAidHJ1ZSIKICAgICAgICBrYXJwZW50ZXIuc2gvZG8tbm90LWRpc3J1cHQ6ICJ0cnVlIgogICAgc3BlYzoKICAgICAgc2VydmljZUFjY291bnQ6IHNjYW5uZXIKICAgICAgc2VydmljZUFjY291bnROYW1lOiBzY2FubmVyCiAgICAgIGF1dG9tb3VudFNlcnZpY2VBY2NvdW50VG9rZW46IGZhbHNlCiAgICAgIGNvbnRhaW5lcnM6CiAgICAgICAgLSBuYW1lOiBzY2FuLWNvbnRhaW5lcgogICAgICAgICAgZW52OgogICAgICAgICAgICAtIG5hbWU6IEpBVkFfT1BUUwogICAgICAgICAgICAgIHZhbHVlOiAtWG1zNTEybSAtWG14NTEybQogICAgICAgICAgICAtIG5hbWU6IEJVUlBfSkFWQV9PUFRTCiAgICAgICAgICAgICAgdmFsdWU6IC1YWDpJbml0aWFsUkFNUGVyY2VudGFnZT03NSAtWFg6TWF4UkFNUGVyY2VudGFnZT03NQogICAgICAgICAgZW52RnJvbToKICAgICAgICAgICAgLSBzZWNyZXRSZWY6CiAgICAgICAgICAgICAgICBuYW1lOiBSRUxFQVNFLU5BTUUtc2Nhbi1jb250cm9sbGVyLXNjYW5uZXItZW52CiAgICAgICAgICBpbWFnZTogcHVibGljLmVjci5hd3MvcG9ydHN3aWdnZXIvcG9ydHN3aWdnZXItaG9zdGVkLXNjYW46MjAyMy45LTE0MDE5CiAgICAgICAgICBpbWFnZVB1bGxQb2xpY3k6IEFsd2F5cwogICAgICAgICAgcmVzb3VyY2VzOgogICAgICAgICAgICBsaW1pdHM6CiAgICAgICAgICAgICAgbWVtb3J5OiAyR2kKICAgICAgICAgICAgcmVxdWVzdHM6CiAgICAgICAgICAgICAgY3B1OiA1MTJNaQogICAgICAgICAgICAgIG1lbW9yeTogMkdpCiAgICAgICAgICBzZWN1cml0eUNvbnRleHQ6CiAgICAgICAgICAgIHJ1bkFzVXNlcjogMTAwMDAwCiAgICAgICAgICAgIHJlYWRPbmx5Um9vdEZpbGVzeXN0ZW06IHRydWUKICAgICAgICAgICAgYWxsb3dQcml2aWxlZ2VFc2NhbGF0aW9uOiBmYWxzZQogICAgICAgICAgICBwcml2aWxlZ2VkOiBmYWxzZQogICAgICAgICAgICBjYXBhYmlsaXRpZXM6CiAgICAgICAgICAgICAgZHJvcDoKICAgICAgICAgICAgICAgIC0gQUxMCiAgICAgICAgICB2b2x1bWVNb3VudHM6CiAgICAgICAgICAgIC0gbW91bnRQYXRoOiAvaG9tZS9idXJwc3VpdGUvCiAgICAgICAgICAgICAgbmFtZTogaG9tZS1idXJwc3VpdGUKICAgICAgICAgICAgLSBtb3VudFBhdGg6IC90bXAKICAgICAgICAgICAgICBuYW1lOiB0bXAKICAgICAgdm9sdW1lczoKICAgICAgICAtIG5hbWU6IGhvbWUtYnVycHN1aXRlCiAgICAgICAgICBlbXB0eURpcjoKICAgICAgICAgICAgc2l6ZUxpbWl0OiAxMEdpCiAgICAgICAgLSBuYW1lOiB0bXAKICAgICAgICAgIGVtcHR5RGlyOgogICAgICAgICAgICBzaXplTGltaXQ6IDUxMk1pCiAgICAgIHJlc3RhcnRQb2xpY3k6IE5ldmVyCiAgICAgIHRlcm1pbmF0aW9uR3JhY2VQZXJpb2RTZWNvbmRzOiAzMAogICAgICBub2RlU2VsZWN0b3I6CiAgICAgICAga3ViZXJuZXRlcy5pby9hcmNoOiBhbWQ2NAo=
      - equal:
          path: data.BSEE_MAX_SCAN_CONCURRENCY
          decodeBase64: true
          value: '"50"'
